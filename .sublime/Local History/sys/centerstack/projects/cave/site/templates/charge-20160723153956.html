<!--======================
 *  Author:		Dave Luke Jr
 *  Company:	CenterStack.io
 *  Description:	charge.html
 *======================-->
{% extends "base.html" %}
{% load widget_tweaks %}
{% load humanize %}
{% load mathfilters %}
{% load staticfiles %}
{% block content_site %}


<!--	Charge
========================================= -->
<div class="pi-row">
	<div class="pi-col-sm-6">
		<div class="portlet light portlet-fit ">
			<!-- <div class="portlet-title">
				<div class="caption">
					<i class="pe-7s-users"> </i>
					<span class="caption-subject base-font"> Charge </span>
				</div>
			</div> -->
			<div class="portlet-body">
				<form role="form" id="payment-form" class="p-15" method="POST" action="">
					{% csrf_token %}
					<div class="pi-row pi-grid-small-margins">
						<div class="pi-col-sm-12">
							<label>Card Number</label>
							<div class="form-group">
								<div class="pi-input-with-icon">
									<div class="pi-input-icon">
										<i class="pe-7s-credit"> </i>
									</div>
									<input type="tel" class="form-control" name="cardNumber" placeholder="•••• •••• •••• ••••" autocomplete="cc-number" required autofocus />
								</div>
							</div>
						</div>
					</div>
					<div class="pi-row pi-grid-small-margins">
						<div class="pi-col-sm-6">
							<label for="cardExpiry">
								<span class="hidden-xs">Expiration Date</span>
								<span class="visible-xs-inline">EXP</span>
								DATE
							</label>
							<div class="form-group">
								<div class="pi-input-with-icon">
									<div class="pi-input-icon">
										<i class="pe-7s-date"> </i>
									</div>
									<input type="tel" class="form-control" name="cardExpiry" placeholder="MM / YY" autocomplete="cc-exp" required />
								</div>
							</div>
						</div>
						<div class="pi-col-sm-6">
							<label for="cardCVC">CVC</label>
							<div class="form-group">
								<div class="pi-input-with-icon">
									<div class="pi-input-icon">
										<i class="pe-7s-key"> </i>
									</div>
									<input type="tel" class="form-control" name="cardCVC" placeholder="CVC" autocomplete="cc-csc" required />
								</div>
							</div>
						</div>
					</div>


					<!--	Button
					========================================= -->
					<div class="pi-row pi-grid-small-margins">
						<div class="pi-col-sm-12">
							<button class="subscribe btn base btn-block" type="button">Charge</button>
						</div>
					</div>
					<div class="pi-row pi-grid-small-margins" style="display:none;">
						<div class="pi-col-sm-12">
							<p class="payment-errors"></p>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>


<!--	Javascript
========================================= -->
<script>
	$(function() {
		var $form = $('#payment-form');
		$form.find('.subscribe').on('click', payWithStripe);

		function payWithStripe(e) {
			e.preventDefault();

			/* Abort if invalid form data */
			if (!validator.form()) {
				return;
			}

			/* Visual feedback */
			$form.find('.subscribe').html('Validating <i class="fa fa-spinner fa-pulse"></i>').prop('disabled', true);

			var PublishableKey = 'pk_test_6eKlYSUJZWIJnmPzHxp3qAYJ';
			Stripe.setPublishableKey(PublishableKey);

			/* Create token */
			var expiry = $form.find('[name=cardExpiry]').payment('cardExpiryVal');
			var ccData = {
				number: $form.find('[name=cardNumber]').val().replace(/\s/g, ''),
				cvc: $form.find('[name=cardCVC]').val(),
				exp_month: expiry.month,
				exp_year: expiry.year
			};

			Stripe.card.createToken(ccData, function stripeResponseHandler(status, response) {
				if (response.error) {
					/* Visual feedback */
					$form.find('.subscribe').html('Try again').prop('disabled', false);
					/* Show Stripe errors on the form */
					$form.find('.payment-errors').text(response.error.message);
					$form.find('.payment-errors').closest('.row').show();
				} else {
					/* Visual feedback */
					$form.find('.subscribe').html('Processing <i class="fa fa-spinner fa-pulse"></i>');
					/* Hide Stripe errors on the form */
					$form.find('.payment-errors').closest('.row').hide();
					$form.find('.payment-errors').text("");
					// response contains id and card, which contains additional card details            
					console.log(response.id);
					console.log(response.card);
					var token = response.id;
					// AJAX - you would send 'token' to your server here.
					$.post('/account/stripe_card_token', {
							token: token
						})
						// Assign handlers immediately after making the request,
						.done(function(data, textStatus, jqXHR) {
							$form.find('.subscribe').html('Payment successful <i class="fa fa-check"></i>');
						})
						.fail(function(jqXHR, textStatus, errorThrown) {
							$form.find('.subscribe').html('There was a problem').removeClass('success').addClass('error');
							/* Show Stripe errors on the form */
							$form.find('.payment-errors').text('Try refreshing the page and trying again.');
							$form.find('.payment-errors').closest('.row').show();
						});
				}
			});
		}
		/* Fancy restrictive input formatting via jQuery.payment library*/
		$('input[name=cardNumber]').payment('formatCardNumber');
		$('input[name=cardCVC]').payment('formatCardCVC');
		$('input[name=cardExpiry').payment('formatCardExpiry');

		/* Form validation using Stripe client-side validation helpers */
		jQuery.validator.addMethod("cardNumber", function(value, element) {
			return this.optional(element) || Stripe.card.validateCardNumber(value);
		}, "Please specify a valid credit card number.");

		jQuery.validator.addMethod("cardExpiry", function(value, element) {
			/* Parsing month/year uses jQuery.payment library */
			value = $.payment.cardExpiryVal(value);
			return this.optional(element) || Stripe.card.validateExpiry(value.month, value.year);
		}, "Invalid expiration date.");

		jQuery.validator.addMethod("cardCVC", function(value, element) {
			return this.optional(element) || Stripe.card.validateCVC(value);
		}, "Invalid CVC.");

		validator = $form.validate({
			rules: {
				cardNumber: {
					required: true,
					cardNumber: true
				},
				cardExpiry: {
					required: true,
					cardExpiry: true
				},
				cardCVC: {
					required: true,
					cardCVC: true
				}
			},
			highlight: function(element) {
				$(element).closest('.form-control').removeClass('success').addClass('error');
			},
			unhighlight: function(element) {
				$(element).closest('.form-control').removeClass('error').addClass('success');
			},
			errorPlacement: function(error, element) {
				$(element).closest('.form-group').append(error);
			}
		});

		paymentFormReady = function() {
			if ($form.find('[name=cardNumber]').hasClass("success") &&
				$form.find('[name=cardExpiry]').hasClass("success") &&
				$form.find('[name=cardCVC]').val().length > 1) {
				return true;
			} else {
				return false;
			}
		}

		$form.find('.subscribe').prop('disabled', true);
		var readyInterval = setInterval(function() {
			if (paymentFormReady()) {
				$form.find('.subscribe').prop('disabled', false);
				clearInterval(readyInterval);
			}
		}, 250);
	});
</script>





{% endblock %}